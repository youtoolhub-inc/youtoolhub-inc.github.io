name: Notify Telegram

on:
  push:
    paths:
      - 'index.html'
      - 'images/**'

jobs:
  notify_telegram:
    runs-on: ubuntu-latest

    steps:
      - name: Get Date and Time
        id: date
        run: echo "current_date=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

      - name: Get Commit Details
        id: commit_info
        run: |
          echo "commit_title=$(git log -1 --pretty=%s)" >> $GITHUB_ENV
          echo "commit_description=$(git log -1 --pretty=%B | tail -n +2)" >> $GITHUB_ENV
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_ENV
          echo "commit_email=$(git log -1 --pretty=%ae)" >> $GITHUB_ENV

      - name: Send Telegram Message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPO_URL: "https://github.com/youtoolhub-inc/youtoolhub-inc.github.io"
          WEBSITE_URL: "https://youtoolhub-inc.github.io/"
          COMMIT_TITLE: ${{ env.commit_title }}
          COMMIT_DESCRIPTION: ${{ env.commit_description }}
        run: |
          # Formata a mensagem de acordo com o estilo Markdown solicitado
          MESSAGE="üöÄ *Website Update!* üöÄ\n"
          MESSAGE+="üåê *Visit the repository:* [YouToolHub Repo]($GITHUB_REPO_URL)\n"
          MESSAGE+="üóíÔ∏è *Commit Details:*\n"
          MESSAGE+="*Commit Title:* $COMMIT_TITLE\n"
          MESSAGE+="*Commit Description:* $COMMIT_DESCRIPTION\n"
          MESSAGE+="For more information, visit: [YouToolHub]($WEBSITE_URL)"

          # Substitui os caracteres de nova linha por %0A para o curl entender as quebras de linha
          PARSED_MESSAGE=$(echo "$MESSAGE" | sed ':a;N;$!ba;s/\n/%0A/g')

          # Envia a mensagem para o canal no Telegram
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="$PARSED_MESSAGE" \
          -d parse_mode="Markdown"
